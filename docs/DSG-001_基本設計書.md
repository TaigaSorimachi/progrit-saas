# DSG-001 基本設計書

## 1. システム基本設計概要

### 1.1 設計目標

- **ユーザビリティ**: 直感的で操作しやすい管理画面
- **セキュリティ**: 堅牢な認証・認可システム
- **拡張性**: SaaS 連携の容易な追加
- **性能**: レスポンシブで高速な操作体験
- **監査性**: 全操作の追跡可能性

### 1.2 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    フロントエンド                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ダッシュボード │ │ユーザー管理 │ │ SaaS連携   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                    バックエンドAPI                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  認証API    │ │ユーザーAPI  │ │ SaaS連携API │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                    データベース層                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ PostgreSQL  │ │    Redis    │ │ ファイルDB  │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 2. 画面設計

### 2.1 メイン画面構成

#### ダッシュボード

- **目的**: システム全体の状況を一目で把握
- **表示項目**:
  - アクティブユーザー数
  - SaaS 接続状況
  - 最近のプロビジョニング活動
  - 承認待ちワークフロー
  - システムアラート

#### ユーザー管理画面

- **機能**: 従業員情報の管理
- **主要操作**:
  - ユーザー一覧表示・検索・フィルタ
  - ユーザー詳細情報の表示・編集
  - CSV インポート・エクスポート
  - 一括操作（部署異動、権限変更等）

#### SaaS 連携管理画面

- **機能**: 外部 SaaS との連携設定
- **主要操作**:
  - SaaS 接続の設定・管理
  - 権限テンプレートの作成・編集
  - 同期状況の監視
  - エラーログの確認

### 2.2 画面レイアウト設計

```
┌─────────────────────────────────────────────────────────────┐
│                      ヘッダー                               │
│  ロゴ    ナビゲーション      ユーザーメニュー   通知         │
├─────────────────────────────────────────────────────────────┤
│        │                                                   │
│ サイド │                                                   │
│ バー   │               メインコンテンツ                      │
│        │                                                   │
│ - ダッシュ│                                                   │
│   ボード │                                                   │
│ - ユーザー│                                                   │
│ - SaaS │                                                   │
│ - 設定  │                                                   │
│        │                                                   │
├─────────────────────────────────────────────────────────────┤
│                      フッター                               │
└─────────────────────────────────────────────────────────────┘
```

## 3. データ設計基本方針

### 3.1 主要エンティティ

```yaml
主要エンティティ:
  - Company: 企業情報
  - User: ユーザー（従業員）情報
  - Department: 部署情報
  - SaaSProvider: SaaSサービス定義
  - SaaSAccount: ユーザーのSaaSアカウント
  - ProvisioningJob: プロビジョニング処理
  - WorkflowRequest: ワークフロー申請
  - AuditLog: 監査ログ
```

### 3.2 データ関連

- **1 対多関係**: Company → Users, Company → Departments
- **多対多関係**: Users ⟷ Roles, Users ⟷ SaaSAccounts
- **階層構造**: Departments (親子関係)
- **ログ系**: 時系列データとして最適化

## 4. API 設計基本方針

### 4.1 RESTful API 設計

```yaml
エンドポイント設計:
  認証:
    - POST /api/auth/login
    - POST /api/auth/logout
    - POST /api/auth/refresh

  ユーザー管理:
    - GET /api/users
    - POST /api/users
    - GET /api/users/:id
    - PUT /api/users/:id
    - DELETE /api/users/:id

  SaaS連携:
    - GET /api/saas/providers
    - POST /api/saas/connections
    - GET /api/saas/accounts
    - POST /api/provisioning/jobs
```

### 4.2 レスポンス形式

```json
{
  "success": true,
  "data": {
    // 実際のデータ
  },
  "meta": {
    "total": 100,
    "page": 1,
    "per_page": 20
  },
  "links": {
    "self": "/api/users?page=1",
    "next": "/api/users?page=2"
  }
}
```

## 5. セキュリティ設計

### 5.1 認証・認可フロー

```
1. ユーザーログイン
   ↓
2. OAuth2.0 / SAML認証
   ↓
3. JWT トークン発行
   ↓
4. API アクセス時の認証確認
   ↓
5. ロールベース認可チェック
   ↓
6. リソースアクセス許可
```

### 5.2 セキュリティ対策

- **認証**: OAuth2.0, SAML2.0, 多要素認証
- **認可**: RBAC (Role-Based Access Control)
- **通信**: HTTPS, TLS 1.3
- **データ**: AES-256 暗号化
- **監査**: 全操作ログの記録

## 6. 業務フロー設計

### 6.1 入社時プロビジョニング

```
1. HR部門がユーザー情報を登録
   ↓
2. 部署・役職に基づく権限テンプレート適用
   ↓
3. 必要に応じて承認ワークフロー実行
   ↓
4. 承認完了後、各SaaSへアカウント作成
   ↓
5. 結果通知（本人・上長・情シス）
   ↓
6. 監査ログ記録
```

### 6.2 退社時デプロビジョニング

```
1. 退職日の事前設定
   ↓
2. 指定日に自動でジョブ実行
   ↓
3. 全SaaSアカウントの無効化・削除
   ↓
4. データアーカイブ処理
   ↓
5. 関係者への通知
   ↓
6. 監査ログ記録
```

### 6.3 異動時権限変更

```
1. 人事情報の更新
   ↓
2. 新部署の権限テンプレート適用
   ↓
3. 不要権限の自動削除
   ↓
4. 変更内容の確認・承認
   ↓
5. SaaSアカウントの権限更新
   ↓
6. 関係者への通知
```

## 7. エラーハンドリング設計

### 7.1 エラー分類

```yaml
エラーレベル:
  - CRITICAL: システム停止レベル
  - ERROR: 機能停止レベル
  - WARNING: 注意喚起レベル
  - INFO: 情報提供レベル

エラータイプ:
  - VALIDATION: 入力値エラー
  - AUTHENTICATION: 認証エラー
  - AUTHORIZATION: 認可エラー
  - EXTERNAL_API: 外部API連携エラー
  - SYSTEM: システム内部エラー
```

### 7.2 エラー処理フロー

```
1. エラー発生
   ↓
2. エラー内容の分類・ログ記録
   ↓
3. ユーザーへの適切なメッセージ表示
   ↓
4. 必要に応じて管理者へ通知
   ↓
5. 自動復旧の試行（可能な場合）
   ↓
6. エラー統計の更新
```

## 8. パフォーマンス設計

### 8.1 レスポンス時間目標

- **API 応答**: 200ms 以内
- **画面表示**: 2 秒以内
- **データ検索**: 500ms 以内
- **ファイル処理**: 30 秒以内

### 8.2 最適化手法

- **フロントエンド**: コード分割、遅延読み込み、キャッシュ活用
- **バックエンド**: クエリ最適化、コネクションプール、非同期処理
- **データベース**: インデックス最適化、パーティション、キャッシュ
- **インフラ**: CDN、ロードバランサー、オートスケーリング

## 9. 監視・運用設計

### 9.1 監視項目

```yaml
システム監視:
  - CPU使用率
  - メモリ使用率
  - ディスク使用率
  - ネットワーク使用率

アプリケーション監視:
  - API応答時間
  - エラー率
  - 同時接続数
  - 処理キュー長

ビジネス監視:
  - アクティブユーザー数
  - SaaS同期成功率
  - プロビジョニング成功率
  - ワークフロー処理時間
```

### 9.2 アラート設定

- **即座**: システム停止、セキュリティインシデント
- **5 分以内**: パフォーマンス劣化、API エラー増加
- **1 時間以内**: 容量不足、定期処理の失敗
- **日次**: 利用統計レポート、容量計画

## 10. テスト設計

### 10.1 テスト戦略

```yaml
テストレベル:
  単体テスト:
    - カバレッジ: 80%以上
    - 対象: ビジネスロジック、ユーティリティ関数

  統合テスト:
    - 対象: API エンドポイント、データベース操作
    - モック: 外部SaaS API

  E2Eテスト:
    - 対象: 主要業務フロー
    - 自動化: CI/CD パイプライン組み込み

  負荷テスト:
    - 同時ユーザー: 100+
    - API リクエスト: 1000+/分
```

### 10.2 テスト環境

- **開発環境**: 機能開発・単体テスト
- **テスト環境**: 統合テスト・E2E テスト
- **ステージング環境**: 本番同等環境でのテスト
- **本番環境**: 実運用環境

## 11. 拡張性設計

### 11.1 SaaS 連携拡張

```typescript
// プラガブルなSaaS連携アーキテクチャ
interface SaaSConnector {
  authenticate(): Promise<void>;
  createUser(user: User): Promise<string>;
  updateUser(userId: string, updates: UserUpdate): Promise<void>;
  deleteUser(userId: string): Promise<void>;
}

class GoogleWorkspaceConnector implements SaaSConnector {
  // Google Workspace固有の実装
}

class SlackConnector implements SaaSConnector {
  // Slack固有の実装
}
```

### 11.2 機能拡張ポイント

- **新しい SaaS 対応**: コネクタープラグインの追加
- **カスタムワークフロー**: ワークフローエンジンの拡張
- **レポート機能**: ダッシュボードウィジェットの追加
- **通知方法**: 通知チャネルの追加

## 12. 移行・導入設計

### 12.1 段階的導入計画

```yaml
Phase 1: 基本機能
  - ユーザー管理
  - 基本SaaS連携（Google, Slack, Microsoft）
  - 基本プロビジョニング

Phase 2: 高度機能
  - ワークフロー・承認機能
  - 権限テンプレート
  - 詳細レポート

Phase 3: 拡張機能
  - 追加SaaS対応
  - AI/ML活用
  - 高度な分析機能
```

### 12.2 データ移行戦略

- **既存データの分析**: 現在の管理方法の調査
- **データクレンジング**: 不整合データの修正
- **段階的移行**: 部署単位での順次移行
- **並行運用**: 一定期間の旧システム併用
