# ARC-001 システム構成図

## 1. システム全体構成

### 1.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│                        SaaSアカウント一元管理システム                    │
├─────────────────────────────────────────────────────────────────┤
│                           フロントエンド                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  管理ダッシュボード  │  │  ユーザー管理画面  │  │  承認フロー画面  │  │
│  │   (Next.js)     │  │   (Next.js)     │  │   (Next.js)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                           バックエンド                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   認証・認可API   │  │   ユーザー管理API │  │   SaaS連携API   │  │
│  │  (Node.js/Express)│  │  (Node.js/Express)│  │  (Node.js/Express)│  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                         データ・ストレージ                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   PostgreSQL    │  │      Redis      │  │   ファイルストレージ │  │
│  │  (メインDB)      │  │   (キャッシュ)    │  │     (AWS S3)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                         外部SaaS連携                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │Google Workspace │  │ Microsoft 365   │  │      Slack      │  │
│  │   (OAuth2.0)    │  │   (OAuth2.0)    │  │   (OAuth2.0)    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 コンポーネント詳細

#### 1.2.1 フロントエンド層

- **技術スタック**: Next.js 14, TypeScript, TailwindCSS, shadcn/ui
- **責任**: ユーザーインターフェース、ユーザー体験、クライアントサイドロジック
- **特徴**: サーバーサイドレンダリング、レスポンシブデザイン、リアルタイム更新

#### 1.2.2 バックエンド層

- **技術スタック**: Node.js, Express, TypeScript, Prisma
- **責任**: ビジネスロジック、API 提供、データ処理、外部連携
- **特徴**: RESTful API、認証・認可、非同期処理、エラーハンドリング

#### 1.2.3 データ層

- **PostgreSQL**: メインデータベース、トランザクション管理
- **Redis**: セッション管理、キャッシュ、一時データ
- **S3**: ファイルストレージ、ログアーカイブ、バックアップ

#### 1.2.4 外部連携層

- **SaaS API**: OAuth2.0 認証、SCIM 対応、Webhook 処理
- **認証プロバイダー**: Okta, Azure AD, Google OAuth
- **通知サービス**: Slack API, SendGrid

## 2. 詳細アーキテクチャ

### 2.1 認証・認可フロー

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   ユーザー   │    │フロントエンド │    │バックエンド │    │認証プロバイダー│
│            │    │             │    │             │    │             │
│     ①      │───▶│             │    │             │    │             │
│  ログイン要求 │    │             │    │             │    │             │
│            │    │      ②      │───▶│             │    │             │
│            │    │  認証API呼び出し│    │             │    │             │
│            │    │             │    │      ③      │───▶│             │
│            │    │             │    │OAuth2.0認証 │    │             │
│            │    │             │    │             │    │      ④      │
│            │    │             │    │             │◀───│  認証結果返却  │
│            │    │             │    │      ⑤      │    │             │
│            │    │             │◀───│  JWTトークン  │    │             │
│            │    │      ⑥      │    │     発行      │    │             │
│            │◀───│  ログイン完了  │    │             │    │             │
│            │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

### 2.2 SaaS 連携アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────┐
│                        SaaS連携管理システム                          │
│                                                                     │
│  ┌─────────────────┐                                                │
│  │  連携管理者UI   │                                                │
│  │                 │                                                │
│  │ ┌─────────────┐ │   ┌─────────────────────────────────────────┐ │
│  │ │SaaS設定管理 │ │   │            SaaS連携エンジン              │ │
│  │ └─────────────┘ │   │                                         │ │
│  │ ┌─────────────┐ │   │  ┌─────────────┐  ┌─────────────┐      │ │
│  │ │権限テンプレート│ │───▶│ コネクタ管理  │  │ 操作スケジューラ│      │ │
│  │ └─────────────┘ │   │  └─────────────┘  └─────────────┘      │ │
│  │ ┌─────────────┐ │   │  ┌─────────────┐  ┌─────────────┐      │ │
│  │ │ワークフロー │ │   │  │ エラーハンドリング │  │  ログ管理   │      │ │
│  │ └─────────────┘ │   │  └─────────────┘  └─────────────┘      │ │
│  └─────────────────┘   └─────────────────────────────────────────┘ │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                    個別SaaS連携モジュール                        │ │
│  │                                                                 │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ │
│  │ │   Google    │ │ Microsoft   │ │    Slack    │ │   GitHub    │ │ │
│  │ │ Workspace   │ │    365      │ │             │ │             │ │ │
│  │ │ Connector   │ │ Connector   │ │ Connector   │ │ Connector   │ │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │ │
│  │                                                                 │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ │
│  │ │ Salesforce  │ │    AWS      │ │    Zoom     │ │   Notion    │ │ │
│  │ │ Connector   │ │ Connector   │ │ Connector   │ │ Connector   │ │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 データフロー

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  ユーザー操作  │    │  UI Layer   │    │ API Layer   │    │ Data Layer  │
│             │    │             │    │             │    │             │
│   ①ユーザー  │───▶│             │    │             │    │             │
│   アクション  │    │             │    │             │    │             │
│             │    │  ②バリデーション│    │             │    │             │
│             │    │  ③UI状態更新 │    │             │    │             │
│             │    │             │    │             │    │             │
│             │    │      ④      │───▶│             │    │             │
│             │    │   API呼び出し │    │             │    │             │
│             │    │             │    │  ⑤認証確認  │    │             │
│             │    │             │    │  ⑥権限検証  │    │             │
│             │    │             │    │             │    │             │
│             │    │             │    │      ⑦      │───▶│             │
│             │    │             │    │  データ操作  │    │             │
│             │    │             │    │             │    │  ⑧DB更新   │
│             │    │             │    │             │    │  ⑨ログ記録  │
│             │    │             │    │             │    │             │
│             │    │             │    │      ⑩      │◀───│             │
│             │    │             │    │   操作結果   │    │             │
│             │    │             │◀───│             │    │             │
│             │    │     ⑪       │    │             │    │             │
│             │◀───│  結果表示    │    │             │    │             │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 3. インフラ構成

### 3.1 AWS 構成（推奨）

```
┌─────────────────────────────────────────────────────────────────────┐
│                            AWS Cloud                                │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                         VPC                                     │ │
│  │                                                                 │ │
│  │  ┌─────────────────────┐    ┌─────────────────────┐            │ │
│  │  │   Public Subnet     │    │   Private Subnet    │            │ │
│  │  │                     │    │                     │            │ │
│  │  │  ┌─────────────────┐│    │  ┌─────────────────┐│            │ │
│  │  │  │   ALB/NLB       ││    │  │   ECS Fargate   ││            │ │
│  │  │  │                 ││    │  │   (API Server)  ││            │ │
│  │  │  └─────────────────┘│    │  └─────────────────┘│            │ │
│  │  │                     │    │                     │            │ │
│  │  │  ┌─────────────────┐│    │  ┌─────────────────┐│            │ │
│  │  │  │   CloudFront    ││    │  │   RDS PostgreSQL││            │ │
│  │  │  │   (CDN)         ││    │  │   (Multi-AZ)    ││            │ │
│  │  │  └─────────────────┘│    │  └─────────────────┘│            │ │
│  │  │                     │    │                     │            │ │
│  │  │                     │    │  ┌─────────────────┐│            │ │
│  │  │                     │    │  │ ElastiCache     ││            │ │
│  │  │                     │    │  │ (Redis)         ││            │ │
│  │  │                     │    │  └─────────────────┘│            │ │
│  │  └─────────────────────┘    └─────────────────────┘            │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │       S3        │  │  CloudWatch     │  │      WAF        │     │
│  │  (File Storage) │  │  (Monitoring)   │  │  (Security)     │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 セキュリティ構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                        セキュリティレイヤー                           │
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │     WAF         │  │  DDoS Protection│  │  SSL/TLS 証明書  │     │
│  │  (Web防火壁)    │  │     (Shield)    │  │  (ACM/Let's Encrypt)│  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │   認証・認可      │  │   API Gateway   │  │   VPC Security  │     │
│  │  (OAuth2.0/JWT) │  │  (Rate Limiting)│  │  (Security Groups)│    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │   データ暗号化   │  │   監査ログ      │  │   バックアップ   │     │
│  │  (AES-256)      │  │  (CloudTrail)   │  │  (Point-in-Time)│     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────────────┘
```

## 4. 非機能要件の実現方法

### 4.1 可用性・信頼性

- **マルチ AZ 配置**: RDS、ECS、ElastiCache
- **ロードバランシング**: ALB/NLB による負荷分散
- **自動スケーリング**: ECS Auto Scaling、RDS 読み書き分離
- **ヘルスチェック**: 多層監視、自動復旧

### 4.2 パフォーマンス

- **CDN**: CloudFront 配信、静的ファイル最適化
- **キャッシュ**: Redis、アプリケーションレベルキャッシュ
- **DB 最適化**: インデックス設計、クエリ最適化
- **非同期処理**: SQS、Lambda、バックグラウンドジョブ

### 4.3 セキュリティ

- **ネットワーク**: VPC、セキュリティグループ、プライベートサブネット
- **認証**: OAuth2.0、JWT、多要素認証
- **暗号化**: 保存時・転送時暗号化、AWS KMS
- **監査**: CloudTrail、アプリケーションログ、アクセスログ

### 4.4 保守性・拡張性

- **コンテナ化**: Docker、ECS Fargate
- **CI/CD**: CodePipeline、GitHub Actions
- **モニタリング**: CloudWatch、アラート設定
- **ログ管理**: CloudWatch Logs、構造化ログ

## 5. 技術選定理由

### 5.1 フロントエンド: Next.js

- **理由**: SSR/SSG 対応、TypeScript 統合、豊富なエコシステム
- **メリット**: SEO 最適化、パフォーマンス、開発効率
- **デメリット**: 学習コスト、サーバー要件

### 5.2 バックエンド: Node.js + Express

- **理由**: JavaScript 統一、高いパフォーマンス、豊富なライブラリ
- **メリット**: 開発効率、非同期処理、スケーラビリティ
- **デメリット**: CPU 集約的処理の制限

### 5.3 データベース: PostgreSQL

- **理由**: ACID 準拠、高い信頼性、豊富な機能
- **メリット**: トランザクション保証、拡張性、JSON 対応
- **デメリット**: 運用コスト、複雑なクエリ最適化

### 5.4 インフラ: AWS

- **理由**: 高い可用性、豊富なサービス、セキュリティ機能
- **メリット**: マネージドサービス、自動スケーリング、グローバル展開
- **デメリット**: ベンダーロックイン、コスト管理の複雑性

## 6. 運用考慮事項

### 6.1 監視・アラート

- **メトリクス**: レスポンス時間、エラー率、リソース使用率
- **ログ**: アプリケーションログ、アクセスログ、監査ログ
- **アラート**: 閾値ベース、異常検知、エスカレーション

### 6.2 バックアップ・災害復旧

- **データバックアップ**: 日次自動バックアップ、Point-in-Time 復旧
- **設定バックアップ**: Infrastructure as Code、設定管理
- **災害復旧**: マルチリージョン、RPO/RTO 定義

### 6.3 セキュリティ運用

- **脆弱性管理**: 定期スキャン、パッチ適用
- **アクセス管理**: 最小権限原則、定期レビュー
- **インシデント対応**: 対応手順、エスカレーション、事後分析
